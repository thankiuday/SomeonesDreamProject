<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call Debug - COCOON</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
        }
        .log-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .log-success {
            border-left-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div class="debug-section">
        <h1>üé• Video Call Debug Tool</h1>
        <p>This tool helps debug video call issues and test functionality.</p>
    </div>

    <div class="debug-section">
        <h2>üìä Environment Check</h2>
        <div id="environment-info">
            <p><strong>Current URL:</strong> <span id="current-url"></span></p>
            <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
            <p><strong>Protocol:</strong> <span id="protocol"></span></p>
            <p><strong>Host:</strong> <span id="host"></span></p>
            <p><strong>Environment:</strong> <span id="environment"></span></p>
        </div>
    </div>

    <div class="debug-section">
        <h2>üß™ Video Call Tests</h2>
        <p>Test different video call scenarios:</p>
        
        <button class="test-button" onclick="testVideoCallAccess()">üîç Test Video Call Access</button>
        <button class="test-button" onclick="testStreamAPI()">üîë Test Stream API</button>
        <button class="test-button" onclick="testCallCreation()">üé• Test Call Creation</button>
        <button class="test-button" onclick="testSpecificCall()">üéØ Test Specific Call</button>
        <button class="test-button" onclick="testStreamVideoSDK()">üì¶ Test Stream Video SDK</button>
        <button class="test-button" onclick="testVideoCallURLParsing()">üîó Test URL Parsing</button>
        
        <div id="test-results"></div>
    </div>

    <div class="debug-section">
        <h2>üîß Manual Tests</h2>
        <p>Try these specific video call links:</p>
        
        <a href="/call/test-call-123" class="test-button">üé• Test Call (/call/test-call-123)</a>
        <a href="/call/faculty-math01-1756030850537" class="test-button">üé• Faculty Call (/call/faculty-math01-1756030850537)</a>
        <a href="/call/student-call-456" class="test-button">üé• Student Call (/call/student-call-456)</a>
        <a href="/call/random-call-id" class="test-button">üé• Random Call (/call/random-call-id)</a>
        <a href="/stream-video-test" class="test-button">üß™ Stream Video SDK Test</a>
    </div>

    <div class="debug-section">
        <h2>üìù Debug Log</h2>
        <div id="debug-log">
            <p>Debug information will appear here...</p>
        </div>
    </div>

    <div class="debug-section">
        <h2>üîç Console Logs</h2>
        <p>Check your browser's console (F12) for detailed logs.</p>
        <div id="console-logs"></div>
    </div>

    <script>
        // Display environment info
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('user-agent').textContent = navigator.userAgent;
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('host').textContent = window.location.host;
        document.getElementById('environment').textContent = window.location.hostname.includes('localhost') ? 'Development' : 'Production';

        const debugLog = document.getElementById('debug-log');
        const testResults = document.getElementById('test-results');
        const consoleLogs = document.getElementById('console-logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function addTestResult(message, type = 'info') {
            const result = document.createElement('div');
            result.className = `status ${type}`;
            result.textContent = message;
            testResults.appendChild(result);
        }

        async function testVideoCallAccess() {
            log('Testing video call access...', 'info');
            
            try {
                const response = await fetch('/call/test-call-123');
                if (response.ok) {
                    log('‚úÖ Video call route accessible', 'success');
                    addTestResult('‚úÖ Video call route accessible', 'success');
                } else {
                    log(`‚ùå Video call route returned ${response.status}`, 'error');
                    addTestResult(`‚ùå Video call route returned ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error accessing video call route: ${error.message}`, 'error');
                addTestResult(`‚ùå Error accessing video call route: ${error.message}`, 'error');
            }
        }

        async function testStreamAPI() {
            log('Testing Stream API configuration...', 'info');
            
            try {
                const response = await fetch('/api/chat/token', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Stream API token endpoint accessible', 'success');
                    addTestResult('‚úÖ Stream API token endpoint accessible', 'success');
                } else {
                    log(`‚ùå Stream API token endpoint returned ${response.status}`, 'error');
                    addTestResult(`‚ùå Stream API token endpoint returned ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing Stream API: ${error.message}`, 'error');
                addTestResult(`‚ùå Error testing Stream API: ${error.message}`, 'error');
            }
        }

        async function testCallCreation() {
            log('Testing call creation...', 'info');
            
            // Test if we can access the main app
            try {
                const response = await fetch('/');
                if (response.ok) {
                    log('‚úÖ Main app accessible - call creation should work', 'success');
                    addTestResult('‚úÖ Main app accessible - call creation should work', 'success');
                } else {
                    log(`‚ùå Main app not accessible: ${response.status}`, 'error');
                    addTestResult(`‚ùå Main app not accessible: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing call creation: ${error.message}`, 'error');
                addTestResult(`‚ùå Error testing call creation: ${error.message}`, 'error');
            }
        }

        async function testSpecificCall() {
            log('Testing specific call ID...', 'info');
            
            const testCallId = 'faculty-math01-1756030850537';
            try {
                const response = await fetch(`/call/${testCallId}`);
                if (response.ok) {
                    log(`‚úÖ Specific call ${testCallId} accessible`, 'success');
                    addTestResult(`‚úÖ Specific call ${testCallId} accessible`, 'success');
                } else {
                    log(`‚ùå Specific call ${testCallId} returned ${response.status}`, 'error');
                    addTestResult(`‚ùå Specific call ${testCallId} returned ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing specific call: ${error.message}`, 'error');
                addTestResult(`‚ùå Error testing specific call: ${error.message}`, 'error');
            }
        }

        async function testStreamVideoSDK() {
            log('Testing Stream Video SDK availability...', 'info');
            
            try {
                // Test if we can access the main app and check for Stream Video SDK
                const response = await fetch('/');
                if (response.ok) {
                    const html = await response.text();
                    
                    // Check if Stream Video SDK CSS is being loaded
                    if (html.includes('stream-io/video-react-sdk')) {
                        log('‚úÖ Stream Video SDK CSS detected in main app', 'success');
                        addTestResult('‚úÖ Stream Video SDK CSS detected', 'success');
                    } else {
                        log('‚ö†Ô∏è Stream Video SDK CSS not detected in main app', 'warning');
                        addTestResult('‚ö†Ô∏è Stream Video SDK CSS not detected', 'warning');
                    }
                    
                    // Check if React components are available
                    if (html.includes('react')) {
                        log('‚úÖ React detected in main app', 'success');
                        addTestResult('‚úÖ React detected', 'success');
                    } else {
                        log('‚ö†Ô∏è React not detected in main app', 'warning');
                        addTestResult('‚ö†Ô∏è React not detected', 'warning');
                    }
                } else {
                    log(`‚ùå Main app not accessible: ${response.status}`, 'error');
                    addTestResult(`‚ùå Main app not accessible: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error testing Stream Video SDK: ${error.message}`, 'error');
                addTestResult(`‚ùå Error testing Stream Video SDK: ${error.message}`, 'error');
            }
        }

        async function testVideoCallURLParsing() {
            log('Testing video call URL parsing...', 'info');
            
            // Test different message formats
            const testMessages = [
                "üé• Faculty Video Call\n\nI've started a video call. Join me here: https://someonesdreamproject-1.onrender.com/call/faculty-math01-1756030850537",
                "üé• Video Call\n\nJoin the video call: https://someonesdreamproject-1.onrender.com/call/faculty-cs02-1756030031996",
                "üé• Test Call\n\nJoin me here: http://localhost:5173/call/test-call-123"
            ];
            
            testMessages.forEach((message, index) => {
                let videoCallUrl = null;
                
                if (message.includes("Join the video call: ")) {
                    videoCallUrl = message.split("Join the video call: ")[1];
                } else if (message.includes("Join me here: ")) {
                    videoCallUrl = message.split("Join me here: ")[1];
                } else if (message.includes("http")) {
                    const urlMatch = message.match(/(https?:\/\/[^\s]+)/);
                    if (urlMatch) {
                        videoCallUrl = urlMatch[1];
                    }
                }
                
                if (videoCallUrl) {
                    log(`‚úÖ Test ${index + 1}: URL extracted successfully - ${videoCallUrl}`, 'success');
                    addTestResult(`‚úÖ Test ${index + 1}: URL extracted successfully`, 'success');
                } else {
                    log(`‚ùå Test ${index + 1}: Failed to extract URL`, 'error');
                    addTestResult(`‚ùå Test ${index + 1}: Failed to extract URL`, 'error');
                }
            });
        }

        // Test sessionStorage functionality
        try {
            sessionStorage.setItem('test', 'working');
            sessionStorage.removeItem('test');
            log('‚úÖ sessionStorage is working', 'success');
        } catch (error) {
            log(`‚ùå sessionStorage error: ${error.message}`, 'error');
        }

        // Test localStorage functionality
        try {
            localStorage.setItem('test', 'working');
            localStorage.removeItem('test');
            log('‚úÖ localStorage is working', 'success');
        } catch (error) {
            log(`‚ùå localStorage error: ${error.message}`, 'error');
        }

        // Initialize
        log('Debug tool initialized', 'info');
        
        // Auto-run basic tests
        setTimeout(() => {
            testVideoCallAccess();
            testStreamAPI();
            testCallCreation();
            testVideoCallURLParsing();
        }, 1000);

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[LOG] ${args.join(' ')}`;
            consoleLogs.appendChild(logEntry);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-error';
            logEntry.textContent = `[ERROR] ${args.join(' ')}`;
            consoleLogs.appendChild(logEntry);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-warning';
            logEntry.textContent = `[WARN] ${args.join(' ')}`;
            consoleLogs.appendChild(logEntry);
        };
    </script>
</body>
</html>
